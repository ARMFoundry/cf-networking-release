<%=
  require 'json'

  VXLAN_OVERHEAD = 50

  toRender = {
    "name" => "cni-wrapper",
    "type" => "cni-wrapper-plugin",
    "cniVersion" => "0.3.0",
    "datastore" => "/var/vcap/data/container-metadata/store.json",
    "iptables_lock_file" => "/var/vcap/data/garden-cni/iptables.lock",
    "overlay_network" => p('cf_networking.network'),
    "health_check_url" => "http://127.0.0.1:" + p('cf_networking.connectivity_agent.health_check_port').to_s,
    "instance_address" => spec.ip,
    "iptables_asg_logging" => p("cf_networking.iptables_asg_logging"),
    "iptables_c2c_logging" => p("cf_networking.iptables_c2c_logging"),
    "dns_servers" => p("cf_networking.dns_servers"),
    "delegate" => {
      "cniVersion" => "0.3.0",
      "name" => "silk",
      "type" => "silk-cni",
      "daemonPort" => p('cf_networking.connectivity_agent.health_check_port'),
      "dataDir" => "/var/vcap/data/host-local",
      "datastore" => "/var/vcap/data/silk/store.json",
      "mtu" => p('cf_networking.mtu') - VXLAN_OVERHEAD,
     }
  }

  JSON.pretty_generate(toRender)
%>
